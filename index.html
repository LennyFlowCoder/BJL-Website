<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BJL Cinematic Universe</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --primary-bg: #111;
            --secondary-bg: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent-gold: #c0a062;
            --error-color: #ff4d4d;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            line-height: 1.6;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: rgba(0, 0, 0, 0.5);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .view { display: none; }
        .view.active { display: block; }
        
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 80px);
            padding: 2rem;
        }

        .content-box {
            background-color: var(--secondary-bg);
            padding: 2.5rem;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        h2 { font-weight: 600; text-align: center; margin-bottom: 1.5rem; }

        .input-group { margin-bottom: 1rem; }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .form-switch { text-align: center; margin-top: 1rem; color: var(--text-secondary); }
        .form-switch a { color: var(--accent-gold); text-decoration: none; font-weight: bold; cursor: pointer; }

        .btn {
            display: inline-block;
            width: 100%;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            transition: transform 0.2s ease, background-color 0.2s ease;
            box-sizing: border-box;
        }
        .btn:hover { transform: scale(1.02); }
        .btn:active { transform: scale(0.99); }
        
        .btn-primary { background-color: var(--accent-gold); color: #000; }
        .btn-primary:hover { background-color: #d4b375; }
        
        .btn-secondary { background-color: #444; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #555; }

        .btn-link { background: none; border: none; color: var(--accent-gold); text-decoration: underline; cursor: pointer; padding: 0; width: auto; }
        
        .error { color: var(--error-color); text-align: center; margin-top: 1rem; min-height: 20px; }
        .success { color: #4CAF50; text-align: center; margin-top: 1rem; }
        
        .admin-container { padding: 2rem; display: flex; flex-direction: column; align-items: center; gap: 2rem; }
        .admin-section { width: 100%; max-width: 800px; }

        .user-list { display: flex; flex-direction: column; gap: 1rem; }
        .user-item { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding: 1rem; background-color: #333; border-radius: 8px; gap: 1rem; }

        .film-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .film-card { background-color: var(--secondary-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.3s ease; }
        .film-card:hover { transform: scale(1.05); }
        .film-card img { width: 100%; height: auto; display: block; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--secondary-bg); padding: 20px; border-radius: 8px; width: 80%; max-width: 900px; }
        .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo">BJL Cinematic Universe</div>
        <div id="header-controls" class="header-controls" style="display:none;">
            <span id="welcome-user"></span>
            <button id="logout-btn" class="btn btn-secondary" style="width: auto;">Logout</button>
        </div>
    </header>

    <main>
        <div id="auth-view" class="view active">
            <div class="container">
                <div class="content-box">
                    <div id="login-form-container">
                        <h2>Login</h2>
                        <form id="login-form">
                            <div class="input-group"><input type="email" id="login-email" required placeholder="E-Mail"></div>
                            <div class="input-group"><input type="password" id="login-password" required placeholder="Passwort"></div>
                            <button type="submit" class="btn btn-primary">Einloggen</button>
                            <p class="form-switch">Noch kein Konto? <a id="show-register">Jetzt registrieren</a></p>
                        </form>
                    </div>
                    <div id="register-form-container" style="display:none;">
                        <h2>Registrieren</h2>
                        <form id="register-form">
                            <div class="input-group"><input type="email" id="register-email" required placeholder="E-Mail"></div>
                            <div class="input-group"><input type="password" id="register-password" required placeholder="Passwort"></div>
                            <button type="submit" class="btn btn-primary">Registrieren</button>
                            <p class="form-switch">Bereits ein Konto? <a id="show-login">Zum Login</a></p>
                        </form>
                    </div>
                    <p id="error-message" class="error"></p>
                </div>
            </div>
        </div>
        
        <div id="dashboard-view" class="view">
            <div class="container">
                <div id="code-entry-section" class="content-box">
                    <h2>Zugangscode erforderlich</h2>
                    <form id="code-form">
                        <div class="input-group"><input type="text" id="access-code" placeholder="XXXXXX" maxlength="6" required></div>
                        <button type="submit" class="btn btn-primary">Freischalten</button>
                    </form>
                    <p id="code-error" class="error"></p>
                    <button id="request-code-btn" class="btn btn-link">Code anfordern</button>
                    <p id="request-message" class="success" style="display:none;">Anfrage gesendet.</p>
                </div>
                <div id="film-gallery-section" style="display:none; width: 100%; text-align: center;">
                    <h2>Filmgalerie</h2>
                    <div id="film-grid" class="film-grid"></div>
                </div>
            </div>
        </div>

        <div id="admin-view" class="view">
             <div class="admin-container">
                <div class="content-box admin-section">
                    <h2>Code-Anfragen</h2>
                    <div id="code-requests-list" class="user-list"></div>
                </div>
                <div class="content-box admin-section">
                    <h2>Neuen Film hochladen</h2>
                    <form id="upload-form">
                        <div class="input-group"><input type="text" id="film-title" placeholder="Filmtitel" required></div>
                        <div class="input-group"><textarea id="film-description" placeholder="Filmbeschreibung" required></textarea></div>
                        <div class="input-group"><label>Coverbild:</label><input type="file" id="film-cover" accept="image/*" required></div>
                        <div class="input-group"><label>Videodatei:</label><input type="file" id="film-video" accept="video/*" required></div>
                        <button type="submit" class="btn btn-primary">Film hochladen</button>
                        <p id="upload-success" class="success" style="display:none;">Film hochgeladen!</p>
                    </form>
                </div>
                <div class="content-box admin-section">
                    <h2>Benutzerübersicht</h2>
                    <div id="user-list" class="user-list"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="video-player-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <video id="video-player" width="100%" controls></video>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const app = new App();
                app.init();
            } catch (e) {
                console.error("Ein kritischer Fehler ist beim Initialisieren der App aufgetreten:", e);
                document.body.innerHTML = '<h1 style="color:red; text-align:center; margin-top: 50px;">Ein kritischer Fehler ist aufgetreten. Bitte prüfen Sie die Entwicklerkonsole (F12).</h1>';
            }
        });

        class App {
            constructor() {
                this.uiManager = new UIManager();
                this.auth = new Auth(this);
                this.codeManager = new CodeManager(this);
                this.filmManager = new FilmManager(this);
            }
            init() {
                this.uiManager.init(this);
                this.auth.init();
                this.codeManager.init();
                this.filmManager.init();
                
                const currentUser = this.auth.getCurrentUser();
                if (currentUser && currentUser.email) {
                    this.showDashboard(currentUser);
                } else {
                    this.uiManager.showView('auth');
                }
            }
            showDashboard(user) {
                this.uiManager.showLoggedInHeader(user.email);
                if (user.email === 'bjl.cinematicuniverse@gmail.com') {
                    this.uiManager.showView('admin');
                    this.codeManager.displayAllUsers();
                    this.codeManager.displayCodeRequests();
                } else {
                    this.uiManager.showView('dashboard');
                    this.uiManager.resetDashboardView();
                }
            }
            logout() {
                this.auth.logout();
                this.uiManager.showLoggedOutHeader();
                this.uiManager.showView('auth');
            }
        }
        
        class UIManager {
            init(app) {
                this.app = app;
                document.getElementById('show-register').addEventListener('click', () => this.toggleAuthForms(true));
                document.getElementById('show-login').addEventListener('click', () => this.toggleAuthForms(false));
                document.getElementById('logout-btn').addEventListener('click', () => this.app.logout());
                document.querySelector('.close-btn').onclick = () => this.hideVideoPlayer();
                document.getElementById('video-player-modal').onclick = (e) => {
                    if (e.target.id === 'video-player-modal') this.hideVideoPlayer();
                };
            }
            showView(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(`${viewId}-view`).classList.add('active');
            }
            showLoggedInHeader(email) {
                document.getElementById('header-controls').style.display = 'flex';
                document.getElementById('welcome-user').textContent = `Willkommen, ${email.split('@')[0]}`;
            }
            showLoggedOutHeader() {
                document.getElementById('header-controls').style.display = 'none';
            }
            toggleAuthForms(showRegister) {
                document.getElementById('login-form-container').style.display = showRegister ? 'none' : 'block';
                document.getElementById('register-form-container').style.display = showRegister ? 'block' : 'none';
                document.getElementById('error-message').textContent = '';
            }
            resetDashboardView() {
                document.getElementById('code-entry-section').style.display = 'block';
                document.getElementById('film-gallery-section').style.display = 'none';
            }
            showVideoPlayer(film) {
                document.getElementById('video-player-modal').classList.add('active');
                document.getElementById('video-player').src = film.video;
            }
            hideVideoPlayer() {
                document.getElementById('video-player-modal').classList.remove('active');
                document.getElementById('video-player').pause();
            }
        }

        class Auth {
            constructor(app) { this.app = app; }
            init() {
                this.users = JSON.parse(localStorage.getItem('users')) || [];
                if (!this.users.find(u => u.email === 'bjl.cinematicuniverse@gmail.com')) {
                    this.users.push({ email: 'bjl.cinematicuniverse@gmail.com', password: 'admin' });
                    this._saveUsers();
                }
                document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); this.login(); });
                document.getElementById('register-form').addEventListener('submit', e => { e.preventDefault(); this.register(); });
            }
            _saveUsers() { localStorage.setItem('users', JSON.stringify(this.users)); }
            register() {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                if (this.users.find(user => user.email === email)) {
                    document.getElementById('error-message').textContent = 'E-Mail bereits registriert.'; return;
                }
                this.users.push({ email, password });
                this._saveUsers();
                alert('Registrierung erfolgreich! Bitte einloggen.');
                this.app.uiManager.toggleAuthForms(false);
            }
            login() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const user = this.users.find(u => u.email === email && u.password === password);
                if (user) {
                    const userIndex = this.users.findIndex(u => u.email === email);
                    this.users[userIndex].lastLogin = new Date().toISOString();
                    this._saveUsers();
                    localStorage.setItem('currentUser', JSON.stringify({ email: user.email }));
                    this.app.showDashboard({ email: user.email });
                } else {
                    document.getElementById('error-message').textContent = 'Ungültige E-Mail oder Passwort.';
                }
            }
            logout() { localStorage.removeItem('currentUser'); }
            getCurrentUser() { return JSON.parse(localStorage.getItem('currentUser')); }
            getAllUsers() { return this.users; }
        }

        class CodeManager {
            constructor(app) { this.app = app; }
            init() {
                this.codes = JSON.parse(localStorage.getItem('codes')) || [];
                this.codeRequests = JSON.parse(localStorage.getItem('codeRequests')) || [];
                document.getElementById('request-code-btn').addEventListener('click', () => this.requestAccessCode());
                document.getElementById('code-form').addEventListener('submit', e => { e.preventDefault(); this.validateCode(); });
            }
            _save() {
                localStorage.setItem('codes', JSON.stringify(this.codes));
                localStorage.setItem('codeRequests', JSON.stringify(this.codeRequests));
            }
            requestAccessCode() {
                const currentUser = this.app.auth.getCurrentUser();
                if (this.codeRequests.includes(currentUser.email)) {
                    alert('Du hast bereits einen Code angefordert.'); return;
                }
                this.codeRequests.push(currentUser.email);
                this._save();
                document.getElementById('request-message').style.display = 'block';
            }
            validateCode() {
                const codeInput = document.getElementById('access-code').value;
                const currentUser = this.app.auth.getCurrentUser();
                const codeIndex = this.codes.findIndex(c => c.code === codeInput && c.user === currentUser.email);
                if (codeIndex === -1) {
                    document.getElementById('code-error').textContent = 'Code ist ungültig.'; return;
                }
                if (this.codes[codeIndex].isUsed) {
                    document.getElementById('code-error').textContent = 'Code wurde bereits verwendet.'; return;
                }
                this.codes[codeIndex].isUsed = true;
                this._save();
                document.getElementById('code-entry-section').style.display = 'none';
                document.getElementById('film-gallery-section').style.display = 'block';
                this.app.filmManager.loadFilmGallery();
            }
            displayCodeRequests() {
                const listEl = document.getElementById('code-requests-list');
                listEl.innerHTML = this.codeRequests.length === 0 ? '<p>Keine offenen Anfragen.</p>' : '';
                this.codeRequests.forEach(email => {
                    const item = document.createElement('div');
                    item.className = 'user-item';
                    item.innerHTML = `<span>${email}</span><button class="btn btn-primary btn-sm" style="width:auto;">Code erstellen</button>`;
                    item.querySelector('button').onclick = () => this.generateAndSendCode(email);
                    listEl.appendChild(item);
                });
            }
            generateAndSendCode(email) {
                const newCode = Math.floor(100000 + Math.random() * 900000).toString();
                this.codes.push({ code: newCode, user: email, isUsed: false });
                this.codeRequests = this.codeRequests.filter(reqEmail => reqEmail !== email);
                this._save();
                sendCodeByEmail(email, newCode);
                this.displayCodeRequests();
            }
            displayAllUsers() {
                const listEl = document.getElementById('user-list');
                const users = this.app.auth.getAllUsers().filter(u => u.email !== 'bjl.cinematicuniverse@gmail.com');
                listEl.innerHTML = users.length === 0 ? '<p>Keine registrierten Benutzer.</p>' : '';
                users.forEach(user => {
                    const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString('de-DE') : 'Nie';
                    const item = document.createElement('div');
                    item.className = 'user-item';
                    item.innerHTML = `<span>${user.email}</span><span>Letzter Login: ${lastLogin}</span>`;
                    listEl.appendChild(item);
                });
            }
        }
        
        class FilmManager {
            constructor(app) { this.app = app; }
            init() {
                this.films = JSON.parse(localStorage.getItem('films')) || [];
                document.getElementById('upload-form').addEventListener('submit', e => { e.preventDefault(); this.uploadFilm(); });
            }
            _saveFilms() { localStorage.setItem('films', JSON.stringify(this.films)); }
            uploadFilm() {
                const title = document.getElementById('film-title').value;
                const description = document.getElementById('film-description').value;
                const coverFile = document.getElementById('film-cover').files[0];
                const videoFile = document.getElementById('film-video').files[0];
                if (!title || !description || !coverFile || !videoFile) {
                    alert('Bitte alle Felder ausfüllen.'); return;
                }
                const newFilm = {
                    id: Date.now(), title, description,
                    cover: URL.createObjectURL(coverFile),
                    video: URL.createObjectURL(videoFile)
                };
                this.films.push(newFilm);
                this._saveFilms();
                alert('Film erfolgreich hochgeladen.');
                document.getElementById('upload-form').reset();
            }
            loadFilmGallery() {
                const filmGrid = document.getElementById('film-grid');
                filmGrid.innerHTML = this.films.length === 0 ? '<p>Keine Filme verfügbar.</p>' : '';
                this.films.forEach(film => {
                    const filmCard = document.createElement('div');
                    filmCard.className = 'film-card';
                    filmCard.innerHTML = `<img src="${film.cover}" alt="${film.title}">`;
                    filmCard.onclick = () => this.app.uiManager.showVideoPlayer(film);
                    filmGrid.appendChild(filmCard);
                });
            }
        }
        
        function sendCodeByEmail(userEmail, accessCode) {
            alert(`E-Mail-Versand an ${userEmail} mit Code ${accessCode} wurde ausgelöst. (Für echten Versand EmailJS konfigurieren)`);
            console.log(`Code für ${userEmail}: ${accessCode}`);
        }
    </script>
</body>
</html>
